

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Network Connectivity API &mdash; Zephyr Project Documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Zephyr Project Documentation" href="../../index.html"/>
        <link rel="up" title="Networking" href="networking.html"/>
        <link rel="next" title="Network Management API" href="network-management-api.html"/>
        <link rel="prev" title="IP Stack Architecture" href="ip-stack-architecture.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Zephyr Project
          

          
          </a>

          
            
            
              <div class="version">
                1.6.99
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introducing_zephyr.html">Introducing Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/boards.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/kernel.html">Zephyr Kernel Primer (version 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/application.html">Application Development Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../porting/porting.html">Porting Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers/drivers.html">Device Drivers and Device Model</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystems.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/bluetooth.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c_library.html">Standard C Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="networking.html">Networking</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="networking.html#source-tree-layout">Source tree layout</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="ip-stack-architecture.html">IP Stack Architecture</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Network Connectivity API</a></li>
<li class="toctree-l4"><a class="reference internal" href="network-management-api.html">Network Management API</a></li>
<li class="toctree-l4"><a class="reference internal" href="buffers.html">Network Buffers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../power_management.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sensor.html">Sensor Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../test/ztest.html">Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/usb.html">USB device stack</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/samples.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/kconfig/index.html">Configuration Options Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/code.html">Contributing Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSING.html">Licensing of Zephyr Project components</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Zephyr Project</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../subsystems.html">Subsystems</a> &raquo;</li>
      
          <li><a href="networking.html">Networking</a> &raquo;</li>
      
    <li>Network Connectivity API</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/subsystems/networking/networking-api-usage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="network-connectivity-api">
<span id="networking-api-usage"></span><h1>Network Connectivity API</h1>
<p>Applications can use the connectivity API defined in <code class="file docutils literal"><span class="pre">net_context.h</span></code>
to create a connection, send or receive data, and close a connection.
The same API can be used when working with UDP or TCP data.</p>
<p>The net_context API is similar to the BSD socket API and mapping between these
two is possible. The main difference between net_context API and BSD socket
API is that the net_context API uses the fragmented network buffers (net_buf)
defined in <code class="file docutils literal"><span class="pre">net/buf.h</span></code> and BSD socket API uses linear memory buffers.</p>
<p>This example creates a simple server that listens to incoming UDP connections
and sends the received data back. You can downlow the example application
source file here <a class="reference external" href="https://gerrit.zephyrproject.org/r/gitweb?p=zephyr.git;a=blob;f=doc/subsystems/networking/connectivity-example-app.c">connectivity-example-app.c</a></p>
<p>This example application begins with some initialization. (Use this as an
example; you may need to do things differently in your own application.)</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define SYS_LOG_DOMAIN &quot;example-app&quot;</span>
<span class="cp">#define SYS_LOG_LEVEL SYS_LOG_LEVEL_DEBUG</span>
<span class="cp">#define NET_DEBUG 1</span>

<span class="cp">#include</span> <span class="cpf">&lt;zephyr.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;net/nbuf.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;net/net_core.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;net/net_context.h&gt;</span><span class="cp"></span>

<span class="cp">#define MY_IP6ADDR { { { 0x20, 0x01, 0x0d, 0xb8, 0, 0, 0, 0, \</span>
<span class="cp">			 0, 0, 0, 0, 0, 0, 0, 0x1 } } }</span>
<span class="cp">#define MY_PORT 4242</span>

<span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">in6addr_my</span> <span class="o">=</span> <span class="n">MY_IP6ADDR</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="n">my_addr6</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">struct</span> <span class="n">net_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">nano_sem</span> <span class="n">quit_lock</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">quit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nano_sem_give</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quit_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_app</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nano_sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quit_lock</span><span class="p">);</span>

	<span class="cm">/* Add our address to the network interface */</span>
	<span class="n">net_if_ipv6_addr_add</span><span class="p">(</span><span class="n">net_if_get_default</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">in6addr_my</span><span class="p">,</span>
			     <span class="n">NET_ADDR_MANUAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NET_INFO</span><span class="p">(</span><span class="s">&quot;Run sample application&quot;</span><span class="p">);</span>

	<span class="n">init_app</span><span class="p">();</span>

	<span class="n">create_context</span><span class="p">();</span>

	<span class="n">bind_address</span><span class="p">();</span>

	<span class="n">receive_data</span><span class="p">();</span>

	<span class="n">nano_sem_take</span><span class="p">(</span><span class="o">&amp;</span><span class="n">quit_lock</span><span class="p">,</span> <span class="n">TICKS_UNLIMITED</span><span class="p">);</span>

	<span class="n">close_context</span><span class="p">();</span>

	<span class="n">NET_INFO</span><span class="p">(</span><span class="s">&quot;Stopping sample application&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>After initialization, first thing application needs to create a context.
Context is similar to a socket.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">create_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">net_context_get</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_ERR</span><span class="p">(</span><span class="s">&quot;Cannot get context (%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Then you need to define the local end point for a connection.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">bind_address</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">net_ipaddr_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_addr6</span><span class="p">.</span><span class="n">sin6_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in6addr_my</span><span class="p">);</span>
	<span class="n">my_addr6</span><span class="p">.</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
	<span class="n">my_addr6</span><span class="p">.</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">MY_PORT</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">net_context_bind</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">my_addr6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_ERR</span><span class="p">(</span><span class="s">&quot;Cannot bind IPv6 UDP port %d (%d)&quot;</span><span class="p">,</span>
			<span class="n">ntohs</span><span class="p">(</span><span class="n">my_addr6</span><span class="p">.</span><span class="n">sin6_port</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Wait until the connection data is received.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define MAX_DBG_PRINT 64</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="nf">udp_recv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">reply_buf</span><span class="p">,</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">header_len</span><span class="p">,</span> <span class="n">recv_len</span><span class="p">,</span> <span class="n">reply_len</span><span class="p">;</span>

	<span class="n">NET_INFO</span><span class="p">(</span><span class="s">&quot;%s received %u bytes&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
	      <span class="n">net_nbuf_appdatalen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">reply_buf</span> <span class="o">=</span> <span class="n">net_nbuf_get_tx</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

	<span class="n">NET_ASSERT</span><span class="p">(</span><span class="n">reply_buf</span><span class="p">);</span>

	<span class="n">recv_len</span> <span class="o">=</span> <span class="n">net_buf_frags_len</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>

	<span class="cm">/* First fragment will contain IP header so move the data</span>
<span class="cm">	 * down in order to get rid of it.</span>
<span class="cm">	 */</span>
	<span class="n">header_len</span> <span class="o">=</span> <span class="n">net_nbuf_appdata</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">NET_ASSERT</span><span class="p">(</span><span class="n">header_len</span> <span class="o">&lt;</span> <span class="n">CONFIG_NET_NBUF_DATA_SIZE</span><span class="p">);</span>

	<span class="n">net_buf_pull</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">header_len</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="n">net_nbuf_get_data</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">net_buf_add</span><span class="p">(</span><span class="n">frag</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">net_buf_frag_add</span><span class="p">(</span><span class="n">reply_buf</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>

		<span class="n">net_buf_frag_del</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reply_len</span> <span class="o">=</span> <span class="n">net_buf_frags_len</span><span class="p">(</span><span class="n">reply_buf</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">);</span>

	<span class="n">NET_ASSERT_INFO</span><span class="p">(</span><span class="n">recv_len</span> <span class="o">!=</span> <span class="n">reply_len</span><span class="p">,</span>
			<span class="s">&quot;Received %d bytes, sending %d bytes&quot;</span><span class="p">,</span>
			<span class="n">recv_len</span><span class="p">,</span> <span class="n">reply_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reply_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">udp_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">status</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_INFO</span><span class="p">(</span><span class="s">&quot;Sent %d bytes&quot;</span><span class="p">,</span> <span class="n">POINTER_TO_UINT</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_dst_addr</span><span class="p">(</span><span class="n">sa_family_t</span> <span class="n">family</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">==</span> <span class="n">AF_INET6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">net_ipaddr_copy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_sin6</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_addr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">NET_IPV6_BUF</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="n">net_sin6</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_family</span> <span class="o">=</span> <span class="n">AF_INET6</span><span class="p">;</span>
		<span class="n">net_sin6</span><span class="p">(</span><span class="n">dst_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sin6_port</span> <span class="o">=</span> <span class="n">NET_UDP_BUF</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">src_port</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udp_received</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">status</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">reply_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">dst_addr</span><span class="p">;</span>
	<span class="n">sa_family_t</span> <span class="n">family</span> <span class="o">=</span> <span class="n">net_nbuf_family</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">dbg</span><span class="p">[</span><span class="n">MAX_DBG_PRINT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dbg</span><span class="p">,</span> <span class="n">MAX_DBG_PRINT</span><span class="p">,</span> <span class="s">&quot;UDP IPv%c&quot;</span><span class="p">,</span>
		 <span class="n">family</span> <span class="o">==</span> <span class="n">AF_INET6</span> <span class="o">?</span> <span class="sc">&#39;6&#39;</span> <span class="o">:</span> <span class="sc">&#39;4&#39;</span><span class="p">);</span>

	<span class="n">set_dst_addr</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_addr</span><span class="p">);</span>

	<span class="n">reply_buf</span> <span class="o">=</span> <span class="n">udp_recv</span><span class="p">(</span><span class="n">dbg</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">net_nbuf_unref</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">net_context_sendto</span><span class="p">(</span><span class="n">reply_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">udp_sent</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">UINT_TO_POINTER</span><span class="p">(</span><span class="n">net_buf_frags_len</span><span class="p">(</span><span class="n">reply_buf</span><span class="p">)),</span>
				 <span class="n">user_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_ERR</span><span class="p">(</span><span class="s">&quot;Cannot send data to peer (%d)&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">net_nbuf_unref</span><span class="p">(</span><span class="n">reply_buf</span><span class="p">);</span>

		<span class="n">quit</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">net_context_recv</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">udp_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_ERR</span><span class="p">(</span><span class="s">&quot;Cannot receive IPv6 UDP packets&quot;</span><span class="p">);</span>

		<span class="n">quit</span><span class="p">();</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Close the context when finished.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Context close */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">close_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">net_context_put</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NET_ERR</span><span class="p">(</span><span class="s">&quot;Cannot close IPv6 UDP context&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="toctree-wrapper compound">
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="network-management-api.html" class="btn btn-neutral float-right" title="Network Management API" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ip-stack-architecture.html" class="btn btn-neutral" title="IP Stack Architecture" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Intel Corporation, Wind River Systems, Inc.
      Last updated on Jan 26, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.6.99',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>
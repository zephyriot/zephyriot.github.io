

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Network Buffers &mdash; Zephyr Project Documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Zephyr Project Documentation" href="../../index.html"/>
        <link rel="up" title="Networking" href="networking.html"/>
        <link rel="next" title="Power Management" href="../power_management.html"/>
        <link rel="prev" title="Network Management API" href="network-management-api.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Zephyr Project
          

          
          </a>

          
            
            
              <div class="version">
                1.6.99
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introducing_zephyr.html">Introducing Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/boards.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel/kernel.html">Zephyr Kernel Primer (version 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/application.html">Application Development Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../porting/porting.html">Porting Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../drivers/drivers.html">Device Drivers and Device Model</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../subsystems.html">Subsystems</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../bluetooth/bluetooth.html">Bluetooth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../c_library.html">Standard C Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logging/index.html">Logging</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="networking.html">Networking</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="networking.html#source-tree-layout">Source tree layout</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="ip-stack-architecture.html">IP Stack Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking-api-usage.html">Network Connectivity API</a></li>
<li class="toctree-l4"><a class="reference internal" href="network-management-api.html">Network Management API</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Network Buffers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../power_management.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sensor.html">Sensor Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shell.html">Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../test/ztest.html">Test Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/usb.html">USB device stack</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../samples/samples.html">Samples and Demos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/kconfig/index.html">Configuration Options Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/code.html">Contributing Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSING.html">Licensing of Zephyr Project components</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Zephyr Project</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../subsystems.html">Subsystems</a> &raquo;</li>
      
          <li><a href="networking.html">Networking</a> &raquo;</li>
      
    <li>Network Buffers</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/subsystems/networking/buffers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="network-buffers">
<h1>Network Buffers</h1>
<p>Network buffers are a core concept of how the networking stack
(as well as the Bluetooth stack) pass data around. The API for them is
defined in <code class="docutils literal"><span class="pre">include/net/buf.h</span></code>.</p>
<div class="section" id="creating-buffers">
<h2>Creating buffers</h2>
<p>Network buffers are created by first defining a pool of them:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">NET_BUF_POOL_DEFINE</span><span class="p">(</span><span class="n">pool_name</span><span class="p">,</span> <span class="n">buf_count</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">user_data_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p>The pool is a static variable, so if it&#8217;s needed to be exported to
another module a separate pointer is needed.</p>
<p>Once the pool has been defined, buffers can be allocated from it with:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">buf</span> <span class="o">=</span> <span class="n">net_buf_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool_name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</pre></div>
</div>
<p>There is no explicit initialization function for the pool or its
buffers, rather this is done implicitly as <code class="xref c c-func docutils literal"><span class="pre">net_buf_alloc()</span></code> gets
called.</p>
<p>If there is a need to reserve space in the buffer for protocol headers
to be prependend later, it&#8217;s possible to reserve this headroom with:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">net_buf_reserve</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">headroom</span><span class="p">);</span>
</pre></div>
</div>
<p>In addition to actual protocol data and generic parsing context, network
buffers may also contain protocol-specific context, known as user data.
Both the maximum data and user data capacity of the buffers is
compile-time defined when declaring the buffer pool.</p>
<p>The buffers have native support for being passed through k_fifo kernel
objects. This is a very practical feature when the buffers need to be
passed from one thread to another. However, since a net_buf may have a
fragment chain attached to it, instead of using the <code class="xref c c-func docutils literal"><span class="pre">k_fifo_put()</span></code>
and <code class="xref c c-func docutils literal"><span class="pre">k_fifo_get()</span></code> APIs, special <code class="xref c c-func docutils literal"><span class="pre">net_buf_put()</span></code> and
<code class="xref c c-func docutils literal"><span class="pre">net_buf_get()</span></code> APIs must be used when passing buffers through
FIFOs. These APIs ensure that the buffer chains stay intact.</p>
</div>
<div class="section" id="common-operations">
<h2>Common Operations</h2>
<p>The network buffer API provides some useful helpers for encoding and
decoding data in the buffers. To fully understand these helpers it&#8217;s
good to understand the basic names of operations used with them:</p>
<dl class="docutils">
<dt>Add</dt>
<dd><p class="first">Add data to the end of the buffer. Modifies the data length value
while leaving the actual data pointer intact. Requires that there is
enough tailroom in the buffer. Some examples of APIs for adding data:</p>
<div class="last highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">net_buf_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">uint8_t</span> <span class="o">*</span><span class="nf">net_buf_add_u8</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">net_buf_add_le16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">net_buf_add_le32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">);</span>
</pre></div>
</div>
</dd>
<dt>Push</dt>
<dd><p class="first">Prepend data to the beginning of the buffer. Modifies both the data
length value as well as the data pointer. Requires that there is
enough headroom in the buffer. Some examples of APIs for pushing data:</p>
<div class="last highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">net_buf_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">net_buf_push_le16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">uint32_t</span> <span class="nf">net_buf_pull_le32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</pre></div>
</div>
</dd>
<dt>Pull</dt>
<dd><p class="first">Remove data from the beginning of the buffer. Modifies both the data
length value as well as the data pointer. Some examples of APIs for
pulling data:</p>
<div class="last highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span><span class="nf">net_buf_pull</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">uint8_t</span> <span class="nf">net_buf_pull_u8</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="kt">uint16_t</span> <span class="nf">net_buf_pull_le16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</pre></div>
</div>
</dd>
</dl>
<p>The Add and Push operations are used when encoding data into the buffer,
whereas Pull is used when decoding data from a buffer.</p>
</div>
<div class="section" id="reference-counting">
<h2>Reference Counting</h2>
<p>Each network buffer is reference counted. The buffer is initially
acquired from a free buffers pool by calling <code class="xref c c-func docutils literal"><span class="pre">net_buf_alloc()</span></code>,
resulting in a buffer with reference count 1. The reference count can be
incremented with <code class="xref c c-func docutils literal"><span class="pre">net_buf_ref()</span></code> or decremented with
<code class="xref c c-func docutils literal"><span class="pre">net_buf_unref()</span></code>. When the count drops to zero the buffer is
automatically placed back to the free buffers pool.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../power_management.html" class="btn btn-neutral float-right" title="Power Management" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="network-management-api.html" class="btn btn-neutral" title="Network Management API" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Intel Corporation, Wind River Systems, Inc.
      Last updated on Jan 26, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.6.99',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>